{% extends 'base.html' %}
{% load static %}

{% block content %}
<section class="appointment-history-section mb-5">
    <h2 class="text-center mb-4">ðŸ“œ Appointment History</h2>

    <!-- Filters & Exports -->
    <div class="mb-3 d-flex flex-wrap justify-content-between gap-2">
        <input type="text" id="searchInput" class="form-control" placeholder="Search by teacher..." style="max-width: 250px;">
        <input type="date" id="dateFilter" class="form-control" style="max-width: 200px;">
        <div>
            <a href="{% url 'export_appointments_pdf' %}" class="btn btn-sm btn-danger me-1">ðŸ“„ Export PDF</a>
            <a href="{% url 'export_appointments_csv' %}" class="btn btn-sm btn-success me-1">ðŸ“Š Export CSV</a>
            <a href="{% url 'export_appointments_json' %}" class="btn btn-sm btn-info">ðŸ—‚ JSON</a>
        </div>
    </div>

    <!-- Table -->
    <div class="table-responsive">
        <table class="table table-striped table-hover shadow-sm rounded" id="appointmentsTable">
            <thead class="table-dark sticky-top">
                <tr>
                    <th onclick="sortTable(0)">Teacher â–²â–¼</th>
                    <th onclick="sortTable(1)">Date â–²â–¼</th>
                    <th onclick="sortTable(2)">Time â–²â–¼</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for appointment in appointments %}
                <tr>
                    <td>{{ appointment.teacher.user.get_full_name }}</td>
                    <td>{{ appointment.date }}</td>
                    <td>{{ appointment.time }}</td>
                    <td>
                        {% if appointment.status == 'Pending' %}
                            <span class="badge bg-warning">{{ appointment.status }}</span>
                        {% elif appointment.status == 'Approved' %}
                            <span class="badge bg-success">{{ appointment.status }}</span>
                        {% elif appointment.status == 'Cancelled' %}
                            <span class="badge bg-danger">{{ appointment.status }}</span>
                        {% else %}
                            <span class="badge bg-secondary">{{ appointment.status }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if appointment.status == 'Pending' %}
                        <a href="{% url 'cancel_appointment' appointment.id %}" class="btn btn-sm btn-outline-danger cancel-btn">Cancel</a>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center text-muted">No appointments found</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination (simple client-side) -->
    <div class="mt-3 text-center">
        <button id="prevPage" class="btn btn-sm btn-secondary me-1">Â« Prev</button>
        <span id="pageInfo">Page 1</span>
        <button id="nextPage" class="btn btn-sm btn-secondary ms-1">Next Â»</button>
    </div>
</section>

<!-- ================= STYLES ================= -->
<style>
.appointment-history-section { padding: 2rem; }
.table thead th { text-align: center; cursor: pointer; }
.table tbody td { vertical-align: middle; text-align: center; }
.table-striped tbody tr:nth-of-type(odd) { background-color: #f8f9fa; }
.table-hover tbody tr:hover { background-color: rgba(0,123,255,0.1); }
.badge { font-size: 0.9rem; padding: 0.4em 0.7em; }
@media (max-width: 768px) {
    table, thead, tbody, th, td, tr { display: block; }
    tr { margin-bottom: 1rem; }
    td { text-align: right; padding-left: 50%; position: relative; }
    td::before { position: absolute; left: 10px; top: 0; content: attr(data-label); font-weight: bold; text-align: left; }
}
</style>

<!-- ================= SCRIPTS ================= -->
<script>
// Search filter
document.getElementById('searchInput').addEventListener('keyup', function() {
    const filter = this.value.toLowerCase();
    const rows = document.querySelectorAll('#appointmentsTable tbody tr');

    rows.forEach(row => {
        const teacher = row.cells[0].textContent.toLowerCase();
        if (teacher.indexOf(filter) > -1) row.style.display = '';
        else row.style.display = 'none';
    });
});

// Date filter
document.getElementById('dateFilter').addEventListener('change', function() {
    const filterDate = this.value;
    const rows = document.querySelectorAll('#appointmentsTable tbody tr');
    rows.forEach(row => {
        const rowDate = row.cells[1].textContent;
        row.style.display = (rowDate === filterDate || filterDate === '') ? '' : 'none';
    });
});

// Sort table
function sortTable(n) {
    const table = document.getElementById("appointmentsTable");
    let switching = true;
    let dir = "asc";
    while (switching) {
        switching = false;
        const rows = table.rows;
        for (let i = 1; i < rows.length - 1; i++) {
            let shouldSwitch = false;
            const x = rows[i].cells[n].textContent.toLowerCase();
            const y = rows[i + 1].cells[n].textContent.toLowerCase();
            if ((dir === "asc" && x > y) || (dir === "desc" && x < y)) { shouldSwitch = true; break; }
            if (shouldSwitch) { rows[i].parentNode.insertBefore(rows[i + 1], rows[i]); switching = true; }
        }
        if (!switching && dir === "asc") { dir = "desc"; switching = true; }
    }
}

// Toast notification for cancel
document.querySelectorAll('.cancel-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
        alert('Appointment canceled successfully!'); // can replace with Bootstrap toast
    });
});

// Simple client-side pagination
const rowsPerPage = 5;
let currentPage = 1;
const rows = document.querySelectorAll('#appointmentsTable tbody tr');
function showPage(page) {
    const totalPages = Math.ceil(rows.length / rowsPerPage);
    currentPage = Math.min(Math.max(1, page), totalPages);
    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    rows.forEach((row, i) => { row.style.display = (i >= start && i < end) ? '' : 'none'; });
    document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
}
document.getElementById('prevPage').addEventListener('click', () => showPage(currentPage - 1));
document.getElementById('nextPage').addEventListener('click', () => showPage(currentPage + 1));
showPage(1); // initialize
</script>
{% endblock %}
